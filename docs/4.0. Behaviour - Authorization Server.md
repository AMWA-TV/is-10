# Behaviour: Authorization Server

_(c) AMWA 2019, CC Attribution-ShareAlike 4.0 International (CC BY-SA 4.0)_

## Keys

### Authorization Server Public Key

The Authorization Server MUST provide all public keys used for signing tokens at a non-protected endpoint, the location
of which will correspond with the value of the the "jwks_uri" property at the server metadata endpoint. The default
value of this endpoint on the API is `/jwks`.

The format of the keys SHOULD be the JSON Web Key (JWK) format described in Section 4 of [RFC 8414][RFC-8414] and
SHOULD form a JSON Web Key Set (JWKS) described in Section 5 of [RFC 8414][RFC-8414]. The Authorization Server MAY
present more than one key within a JSON Web Key Set, with each key being an entry in the "keys" array.

Any JSON web Keys used to sign tokens for NMOS APIs MUST use a `kid` (Key ID) matching the following regular
expression. The trailing integer in this expression is intended to be an integer timestamp matching the issue time of
the key to facilitate key rotation.
```
^x-nmos-\d+$
```

### Changing Keys

When transitioning to a new public/private key pair used for signing tokens the Authorization Server SHOULD provide
both the old and new public key at the public key endpoint until all tokens that may be verified by the old public key
would have expired. However, if a private key is known to be compromised, the Authorization Server MUST remove it
from the public key endpoint immediately.

Authorization Servers SHOULD provide new public keys at the public key endpoint endpoint for at least 2 hours before
issuing tokens signed by the corresponding private key to allow time for clients to cache the new public key.

## Client Registration

The Authorization Server MUST NOT grant tokens to unregistered clients.

Authorization Servers SHOULD support a manual mechanism for registering clients (e.g an HTML web form) allowing the
client type and redirect URIs to be provided.

Clients and Authorization Servers MUST provide for the OAuth 2.0 Dynamic Client Registration Protocol
[RFC 7591][RFC-7591] to allow dynamic registration of clients to the Authorization Server to allow for
zero-configuration setup. This endpoint MUST be protected by a transport-layer security mechanism.

Whilst it is RECOMMENDED that clients provide a means of authorization when registering dynamically (which is beyond
the scope of this specification), Section 3 of [RFC 7591][RFC-7591] permits that clients may register with no
authorization. The client registration endpoint SHOULD be rate-limited to prevent Denial-of-Service attacks.

After successful registration, the Authorization Server MUST generate a Client ID and, in the case of a confidential
client, a Client Secret. Public Clients SHOULD NOT be issued with a client secret, and Authorization Servers MUST NOT
accept client credentials as valid authentication for a public client. The Client ID MUST be at least 20 characters
long and MUST be unique to each client. Client credentials MUST be returned to the client in the response of a
successful dynamic client registration. The method by which client credentials are passed to a client during manual
registration is beyond the scope of this specification.

AMWA NMOS Specifications MAY specify additional registration parameters where they require them. Where clients and
Authorization Servers that support OAuth 2.0 are used with these specifications they SHALL use these parameters in
all OAuth 2.0 registration mechanisms they support.

### Client Authentication

Authorization Servers SHOULD provide support for client authentication providing client credentials using HTTP Basic
Authentication, as per Section 2 of [RFC 2617][RFC-2617], in the manner described in Section 2.3. of
[RFC 6749][RFC-6749].

The means by which authentication is established is beyond the scope of this specification but may include:
*   A valid Client TLS certificate
*   Operator Approval via a Web GUI
*   Logging in using a Single-Sign-On (SSO) system
*   An initial JSON Web Token (JWT) as suggested in Section 3 of [RFC 7591][RFC-7591]

### Client De-Registration

The Authorization Server SHOULD support the de-registration of clients in the case of a compromised client. The means
by which this client de-registration occurs is beyond the scope of this specification.

## Responding to Token Requests

Refer to [Token Requests](./4.2.%20Behaviour%20-%20Token%20Requests.md).

## Audit Requirements

Authorization Servers MUST maintain a log of each authorization and client registration which is performed, including
initial token generation and token refreshes. Logs MUST be stored alongside an accurate timestamp and an identifier for
the user who authorized the action. Logs MUST NOT contain sensitive information such as secrets. Logs SHOULD be stored
securely and maintained for at least one month.


[RFC-2617]: https://tools.ietf.org/html/rfc2617 "HTTP Authentication: Basic and Digest Access Authentication"

[RFC-4716]: https://tools.ietf.org/html/rfc4716 "The Secure Shell (SSH) Public Key File Format"

[RFC-6749]: https://tools.ietf.org/html/rfc6749 "The OAuth 2.0 Authorization Framework"

[RFC-7591]: https://tools.ietf.org/html/rfc7591 "OAuth 2.0 Dynamic Client Registration Protocol"

[RFC-8414]: https://tools.ietf.org/html/rfc8414 "OAuth 2.0 Authorization Server Metadata"
