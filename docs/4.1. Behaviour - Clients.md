# Behaviour: Clients

## Discovery

Clients MUST be capable of discovering the location of an Authorization Server using DNS Service Discovery. Clients
MAY also permit manual configuration of one or more Authorization Servers.

When first contacting an Authorization Server, a Client MUST identify the location of API endpoints using the
Authorization Server Metadata resource as specified in [RFC 8414][RFC-8414]. Clients MUST NOT assume that every
Authorization Server instance on a network uses the same endpoint locations.

## Client Registration

Clients MUST be registered with the Authorization Server before initiating the OAuth 2.0 protocol as per Section 2
of [RFC 6749][RFC-6749]. Clients MAY assume that all discovered Authorization Servers on a network use the same
database of client registrations.

Clients SHOULD support a mechanism for providing the information required for OAuth 2.0 registration (e.g a web-page
containing the required details).

Clients are RECOMMENDED to provide for the OAuth 2.0 Dynamic Client Registration Protocol [RFC 7591][RFC-7591] to allow
for zero-configuration setup. NMOS Nodes SHOULD be capable of registering dynamically in order to limit the configuration
associated with large numbers of Nodes coming online simultaneously.

## Client Credentials

Clients operating with a client secret SHOULD support using HTTP Basic Authentication, as per Section 2 of
[RFC 2617][RFC-2617], to authenticate with the Authorization Server in the manner described in Section 2.3.1 of
[RFC 6749][RFC-6749].

Client credentials SHOULD be stored by the client in a safe, permission-restricted, location in non-volatile memory in
case of a device restart to prevent duplicate registrations. Client secrets SHOULD be hashed before being stored to reduce the chance of client secret leaking.

## Client Endpoints

Clients implementing the Authorization Code Grant MUST host at least a single endpoint, the Redirection Endpoint, as
described in Section 3.1.2 in [RFC 6749][RFC-6749], capable of receiving a request containing the authorization code.
This endpoint MUST be identical to one of the entries in the array of redirect URI's registered during client
registration.

All registered redirect URI's for Clients SHOULD mandate use of TLS or other transport-layer security
method.

Clients SHOULD host a second endpoint, capable of generating a valid redirect to the Authorization Server's
authorization endpoint, to facilitate the authorising of NMOS devices.

Public Clients MUST support PKCE as outlined in [RFC 7636][RFC-7636].

## Client Types

### Native Applications

Native applications (such as Desktop Applications) are regarded as Public Clients according to Section 2.1 of [RFC 6749][RFC-6749].

Native applications SHOULD abide by the guidelines set out in OAuth 2.0 for Native Apps [RFC 8252][RFC-8252].

Native Applications MUST make authorization requests through external user-agents, such as a browser on the same device.

Registered redirect URI's MUST comply with Section 7 of [RFC 8252][RFC-8252].

### User-agent-based / Browser Applications

Client-side and Browser-based applications (such as Single-Page Web Applications) are regarded as Public Clients according to Section 2.1 of [RFC 6749][RFC-6749].

Client-side web applications SHOULD abide by the guidelines set out in [OAuth 2.0 for Browser-Based Apps][draft-ietf-oauth-browser-based-apps-04].

Browser-based applications communicating with an Authorization Server on the same domain are RECOMMENDED to take advantage of using domain-specific, HTTP-Only cookies to pass access tokens to Resource Servers, due to their resilience to Cross-Site Scripting attacks.

## Requesting a Token

Refer to [Token Requests](./4.2.%20Behaviour%20-%20Token%20Requests.md).

## Refreshing a Token

Clients SHOULD ensure access tokens are refreshed sufficiently in advance of their expiry. While the exact time will
depend on the implementation of the client and Authorization Server, it is RECOMMENDED to attempt a refresh at least 15
seconds before expiry (i.e the half-life of the shortest-lived token possible).

## Accessing Protected Resources

When accessing protected resources clients MUST include the authorization token in the request using the Authorization
Request Header Field method described in Section 2.1 of [RFC 6750][RFC-6750]. Clients MUST NOT use any of the other
methods specified in Section 2.0 of [RFC 6750][RFC-6750] when making requests via HTTP/S, except for the case noted for
WebSockets in [Resource Servers](./4.4.%20Behaviour%20-%20Resource%20Servers.md). Access tokens MUST NOT be base64
encoded before being sent in a request.

Clients MUST be capable of handling early revocation of tokens, which will be signalled by Resource Servers using HTTP
4xx error codes.


[RFC-2617]: https://tools.ietf.org/html/rfc2617 "HTTP Authentication: Basic and Digest Access Authentication"

[RFC-6749]: https://tools.ietf.org/html/rfc6749 "The OAuth 2.0 Authorization Framework"

[RFC-6750]: https://tools.ietf.org/html/rfc6750 "The OAuth 2.0 Authorization Framework: Bearer Token Usage"

[RFC-7591]: https://tools.ietf.org/html/rfc7591 "OAuth 2.0 Dynamic Client Registration Protocol"

[RFC-8252]: https://tools.ietf.org/html/rfc8252 "OAuth 2.0 for Native Apps"

[RFC-8414]: https://tools.ietf.org/html/rfc8414 "OAuth 2.0 Authorization Server Metadata"

[draft-ietf-oauth-browser-based-apps-04]: https://tools.ietf.org/html/draft-ietf-oauth-browser-based-apps-04 "OAuth 2.0 for Browser-Based Apps"
